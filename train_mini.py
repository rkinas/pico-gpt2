import os,math as m,random as r;r.seed(42);os.path.exists('input.txt')or __import__('urllib.request').request.urlretrieve('https://raw.githubusercontent.com/karpathy/makemore/refs/heads/master/names.txt','input.txt');D=[l.strip()for l in open('input.txt').read().strip().split('\n')if l.strip()];r.shuffle(D);print(f"num docs: {len(D)}");U=sorted(set(''.join(D)));B=len(U);Z=B+1;print(f"vocab size: {Z}")
V=type('V',(),{'__init__':lambda s,d,c=(),l=():s.__dict__.update(d=d,g=0,_c=c,_l=l),'__add__':lambda s,o:V(s.d+(o:=o if isinstance(o,V)else V(o)).d,(s,o),(1,1)),'__mul__':lambda s,o:V(s.d*(o:=o if isinstance(o,V)else V(o)).d,(s,o),(o.d,s.d)),'__pow__':lambda s,o:V(s.d**o,(s,),(o*s.d**(o-1),)),'log':lambda s:V(m.log(s.d),(s,),(1/s.d,)),'exp':lambda s:V(m.exp(s.d),(s,),(m.exp(s.d),)),'relu':lambda s:V(max(0,s.d),(s,),(float(s.d>0),)),'__neg__':lambda s:s*-1,'__radd__':lambda s,o:s+o,'__sub__':lambda s,o:s+(-o),'__truediv__':lambda s,o:s*o**-1,'backward':lambda s:(lambda t,v:((b:=lambda n:n not in v and(v.add(n),[b(c)for c in n._c],t.append(n))),b(s),s.__setattr__('g',1),[c.__setattr__('g',c.g+l*n.g)for n in reversed(t)for c,l in zip(n._c,n._l)]))([], set())});E,H,W=16,4,16;R=E//H;mx=lambda a,b,d=.08:[[V(r.gauss(0,d))for _ in range(b)]for _ in range(a)];S={'wte':mx(Z,E),'wpe':mx(W,E),'lm_head':mx(Z,E)};S.update({f'layer0.attn_w{k}':mx(E,E)for k in'qkvo'});S['layer0.mlp_fc1']=mx(4*E,E);S['layer0.mlp_fc2']=mx(E,4*E);P=[p for w in S.values()for o in w for p in o];print(f"num params: {len(P)}");lr,b1,b2,ea=.01,.85,.99,1e-8;M=[0.]*len(P);N=[0.]*len(P)
F=lambda x,w:[sum(a*b for a,b in zip(o,x))for o in w];X=lambda g:(lambda e:(lambda t:[i/t for i in e])(sum(e)))([(v-max(a.d for a in g)).exp()for v in g]);J=lambda x:(lambda c:[a*c for a in x])((sum(a*a for a in x)/len(x)+1e-5)**-.5)
def G(i,p,K,C):x=J([a+b for a,b in zip(S['wte'][i],S['wpe'][p])]);y=x;x=J(x);q,k,v=F(x,S['layer0.attn_wq']),F(x,S['layer0.attn_wk']),F(x,S['layer0.attn_wv']);K[0].append(k);C[0].append(v);a=sum([(lambda q,k,v:(lambda w:[sum(w[t]*v[t][j]for t in range(len(v)))for j in range(R)])(X([sum(q[j]*k[t][j]for j in range(R))/R**.5 for t in range(len(k))])))(q[h*R:(h+1)*R],[i[h*R:(h+1)*R]for i in K[0]],[i[h*R:(h+1)*R]for i in C[0]])for h in range(H)],[]);x=[a+b for a,b in zip(F(a,S['layer0.attn_wo']),y)];y=x;x=[a.relu()for a in F(J(x),S['layer0.mlp_fc1'])];x=[a+b for a,b in zip(F(x,S['layer0.mlp_fc2']),y)];return F(x,S['lm_head'])
for s in range(1000):d=D[s%len(D)];t=[B]+[U.index(c)for c in d]+[B];n=min(W,len(t)-1);K,C=[[],],[[],];L=sum([-X(G(t[p],p,K,C))[t[p+1]].log()for p in range(n)])/n;L.backward();z=lr*(1-s/1000);[(M.__setitem__(i,b1*M[i]+(1-b1)*p.g),N.__setitem__(i,b2*N[i]+(1-b2)*p.g**2),p.__setattr__('d',p.d-z*(M[i]/(1-b1**(s+1)))/((N[i]/(1-b2**(s+1)))**.5+ea)),p.__setattr__('g',0))for i,p in enumerate(P)];print(f"step {s+1:4d} / 1000 | loss {L.d:.4f}")
print("\n--- inference (new, hallucinated names) ---");g=lambda K,C,t,p,s:s if p>=W or(n:=r.choices(range(Z),weights=[a.d for a in X([l/.5 for l in G(t,p,K,C)])])[0])==B else g(K,C,n,p+1,s+[U[n]])
for i in range(20):print(f"sample {i+1:2d}: {''.join(g([[],],[[],],B,0,[]))}")
